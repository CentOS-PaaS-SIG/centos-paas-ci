#######################################
## MULTI-JOB TO WRAP AROUND ALL JOBS ##
#######################################

- job-template:
    name: '{ocname}-0-multijob'
    defaults: openshift-defaults
    concurrent: false
    node: master
    project-type: multijob
    scm:
        - paas-sig-ci-scm
    triggers:
        - timed: "H */6 * * *"
    builders:
      - multijob:
          name: ProvisionCluster
          condition: SUCCESSFUL
          projects:
            - name: '{ocname}-1-provision-cluster'
              kill-phase-on: FAILURE
              abort-all-job: true
              current-parameters: true
      - multijob:
          name: PrepCluster
          condition: SUCCESSFUL
          projects:
            - name: '{ocname}-2-prep-cluster'
              kill-phase-on: FAILURE
              abort-all-job: true
              current-parameters: true
      - multijob:
          name: TeardownCluster
          condition: SUCCESSFUL
          projects:
            - name: '{ocname}-6-teardown-cluster'
              kill-phase-on: FAILURE
              abort-all-job: true
              current-parameters: true
#      - multijob:
#          name: OpenshiftAnsibleRpms
#          condition: SUCCESSFUL
#          projects:
#            - name: '{ocname}-4-openshift-ansible-rpms'
#              kill-phase-on: FAILURE
#              abort-all-job: true
#              current-parameters: true
#      - multijob:
#          name: DeployAOSI
#          condition: SUCCESSFUL
#          projects:
#            - name: '{ocname}-5-deploy-aosi'
#              kill-phase-on: FAILURE
#              abort-all-job: true
#              current-parameters: true

#      - multijob:
#          name: Provision-Deploy-e2etests
#          condition: SUCCESSFUL
#          projects:
#            - name: '{ocname}-6-test-matrix'
#              kill-phase-on: FAILURE
#              abort-all-job: true
#              current-parameters: true

- job-template:
    name: '{ocname}-1-provision-cluster'
    defaults: openshift-defaults
    concurrent: false
    node: '{jslave_name}'
    scm:
      - paas-sig-ci-scm
    builders:
      - shining-panda:
          build-environment: virtualenv
          python-version: system-CPython-2.7
          name: venv
          clear: true
          use-distribute: false
          system-site-packages: true
          command: |
            {install-ansible21}
            {configure-ansible}
            {configure-linchpin}
            {duffy-topology}
            {provision-cluster}
    publishers:
        - archive:
            artifacts: "**/*.output, **/*.inventory"
            allow-empty: 'false'

- job-template:
    name: '{ocname}-2-prep-cluster'
    defaults: openshift-defaults
    concurrent: false
    node: '{jslave_name}'
    scm:
      - paas-sig-ci-scm
    builders:
      - copyartifact:
          project: '{ocname}-1-provision-cluster'
          filter: "**/*.inventory"
          target: $WORKSPACE
          which-build: multijob-build
      - shell: |
          {prep_cluster}

- job-template:
    name: '{ocname}-6-teardown-cluster'
    defaults: openshift-defaults
    concurrent: false
    node: '{jslave_name}'
    scm:
      - paas-sig-ci-scm
    builders:
      - copyartifact:
          project: '{ocname}-1-provision-cluster'
          filter: "**/*.output"
          target: $WORKSPACE
          which-build: multijob-build
      - shining-panda:
          build-environment: virtualenv
          python-version: system-CPython-2.7
          name: venv
          clear: true
          use-distribute: false
          system-site-packages: true
          command: |
            {install-ansible21}
            {configure-ansible}
            {configure-linchpin}
            {duffy-topology}
            {teardown-cluster}

#######################
# MATRIX JOB TESTING ##
# OPENSHIFT_VER      ##
# CONTANERIZED       ##
# TOPOLOGY           ##
#######################

#- job-template:
#    name: '{ocname}-2-test-matrix'
#    defaults: openshift-defaults
#    concurrent: false
#    project-type: matrix
#    execution-strategy:
#      combination-filter: |
#        {combo-filter}
#    scm:
#      - paas-sig-ci-scm
#    builders:
#        - copyartifact:
#            project: '{ocname}-1-provision-cluster'
#            filter: '*.inventory'
#            target: $WORKSPACE
#            which-build: multijob-build
#        - shell: |
#            {prep-cluster}
#    publishers:
#        - archive:
#            artifacts: '*.txt'
#            allow-empty: 'false'
#        - teardown-resources
#
#        - conditional-step:
#            condition-kind: regex-match
#            regex: ^3.[1-9]$
#            label: ${{ENV,var="OSE_VER"}}
#            on-evaluation-failure: dont-run
#            steps:
#              - shell: |
#                  {run-e2e-tests}
#        - conditional-step:
#            condition-kind: regex-match
#            regex: ^3.[1-9]$
#            label: ${{ENV,var="OSE_VER"}}
#            on-evaluation-failure: dont-run
#            steps:
#              - shell: |
#                  {upgrade-ose}

- job-group:
    name: openshift-provision-prep-test-teardown
    jobs:
        - '{ocname}-0-multijob'
        - '{ocname}-1-provision-cluster'
        - '{ocname}-2-prep-cluster'
        - '{ocname}-6-teardown-cluster'
